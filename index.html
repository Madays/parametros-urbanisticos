<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Google Maps with Side Panel</title>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        font-family: Arial, sans-serif;
      }

      #map {
        height: calc(100% - 28px); /* leave space for title */
        width: calc(100%); /* leave space for side panel */
        float: left;
      }

      #pac-input {
        position: absolute;
        top: 30%;
        left: 50%;
        transform: translateX(-50%);
        width: 350px;
        padding: 10px;
        border: 1px solid #ff8126;
        border-radius: 50px;
        font-size: 14px;
        outline: none;
        z-index: 5;
        background: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2), 0 -1px 0px rgba(0, 0, 0, 0.02);
        /* border: none; */
      }

      ::placeholder {
        color: black;
        opacity: 1;
      }

      /* Side panel */
      #side-panel {
        width: 300px;
        height: 100%;
        position: absolute;
        right: 0;
        background: #f9f9f9;
        border-left: 1px solid #ccc;
        padding: 20px;
        box-sizing: border-box;
        overflow-y: auto;
        display: none;
      }

      #side-panel h2 {
        margin-top: 0;
        font-size: 18px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
      }
      .title {
        text-align: center;
        font-size: 24px;
        margin: 20px 0;
      }
      .info-title {
        font-weight: bold;
        display: inline-block;
        width: 200px;
        color: green;
      }
    </style>
  </head>
  <body>
    <!-- Input for search -->
    <input id="pac-input" type="text" placeholder="Buscar dirección..." />
    <h1 class="title">Obten tus parámetros urbanistico</h1>
    <!-- Map container -->
    <div id="map"></div>

    <!-- Side panel -->
    <div id="side-panel">
      <div id="details">Seleccione una dirección en el mapa...</div>
    </div>

    <!-- Google Maps JS API -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCTd7seJg3oTHDT-F_3DMj3TI5bwxwXx0k&libraries=places&callback=initMap"
      async
      defer
    ></script>

    <script>
      let map, marker

      function initMap() {
        const initialLocation = {
          lat: -14.075918947331441,
          lng: -75.7341649817146,
        } // Lima

        map = new google.maps.Map(document.getElementById("map"), {
          center: initialLocation,
          zoom: 13,
        })

        marker = new google.maps.Marker({
          position: initialLocation,
          map: map,
        })
        // Cargar GeoJSON en el mapa
        map.data.loadGeoJson("process_geojson/CATASTRO_ICA_enriquecido.geojson")
        map.data.setStyle({
          fillColor: "orange",
          strokeColor: "orange",
          strokeWeight: 1,
        })
        // Autocomplete setup
        const input = document.getElementById("pac-input")
        const autocomplete = new google.maps.places.Autocomplete(input)
        autocomplete.bindTo("bounds", map)

        // When a place is selected
        autocomplete.addListener("place_changed", () => {
          const place = autocomplete.getPlace()

          if (!place.geometry || !place.geometry.location) {
            alert("No se encontró la dirección seleccionada")
            return
          }

          // Move map and marker
          if (place.geometry.viewport) {
            map.fitBounds(place.geometry.viewport)
          } else {
            map.setCenter(place.geometry.location)
            map.setZoom(21)
          }
          marker.setPosition(place.geometry.location)

          // Check if the selected point is inside any polygon from process_geojson/CATASTRO_ICA_enriquecido.geojson
          fetch("process_geojson/CATASTRO_ICA_enriquecido.geojson")
            .then((response) => response.json())
            .then((geojson) => {
              const point = [
                place.geometry.location.lng(),
                place.geometry.location.lat(),
              ]

              // Helper function to check if point is inside a polygon
              function pointInPolygon(point, polygon) {
                let inside = false
                for (
                  let i = 0, j = polygon.length - 1;
                  i < polygon.length;
                  j = i++
                ) {
                  const xi = polygon[i][0],
                    yi = polygon[i][1]
                  const xj = polygon[j][0],
                    yj = polygon[j][1]
                  const intersect =
                    yi > point[1] !== yj > point[1] &&
                    point[0] <
                      ((xj - xi) * (point[1] - yi)) / (yj - yi + 0.0000001) + xi
                  if (intersect) inside = !inside
                }
                return inside
              }

              let found = false
              let infoCatastro = {}
              geojson.features.forEach((feature) => {
                if (feature.geometry.type === "Polygon") {
                  const coordinates = feature.geometry.coordinates[0]
                  if (pointInPolygon(point, coordinates)) {
                    found = true
                    infoCatastro = feature.properties
                  }
                } else if (feature.geometry.type === "MultiPolygon") {
                  feature.geometry.coordinates.forEach((polygon) => {
                    if (pointInPolygon(point, polygon[0])) {
                      found = true
                      infoCatastro = feature.properties
                    }
                  })
                }
              })

              const detailsDiv = document.getElementById("details")
              if (found) {
                detailsDiv.innerHTML += `<p style="color:green;"><strong>${infoCatastro.zona}</strong></p>
                <p><div class="info-title">densidad_neta_max_hab_ha: </div> <div class="info-value">${infoCatastro.densidad_neta_max_hab_ha}</div></p>
                <p><div class="info-title">area_minima_lote_m2: </div> <div class="info-value">${infoCatastro.area_minima_lote_m2}</div></p>
                <p><div class="info-title">altura_maxima_metros: </div> <div class="info-value">${infoCatastro.altura_maxima_metros}</div></p>
                <p><div class="info-title">Area_minima_lote_m2: </div> <div class="info-value">${infoCatastro.area_minima_lote_m2}</div></p>
                <p><div class="info-title">frente_minimo_ml: </div> <div class="info-value">${infoCatastro.frente_minimo_ml}</div></p>`
              } else {
                detailsDiv.innerHTML += `<p style="color:red;"><strong>Punto fuera de los polígonos del catastro.</strong></p>`
              }
            })
            .catch(() => {
              const detailsDiv = document.getElementById("details")
              detailsDiv.innerHTML += `<p style="color:red;"><strong>Error al cargar el archivo GeoJSON.</strong></p>`
            })

          // Fill side panel with details
          const sidePanel = document.getElementById("side-panel")
          sidePanel.style.display = "block"

          const detailsDiv = document.getElementById("details")
          detailsDiv.innerHTML = `
            <p><strong>Nombre:</strong> ${place.name || "N/A"}</p>
            <p><strong>Dirección:</strong> ${
              place.formatted_address || "N/A"
            }</p>
            <p><strong>Coordenadas:</strong> ${place.geometry.location
              .lat()
              .toFixed(6)}, ${place.geometry.location.lng().toFixed(6)}</p>
          `
        })
      }

      window.initMap = initMap
    </script>
  </body>
</html>
